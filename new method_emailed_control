-----Start ROCK code-----
DEFINE start_wk_idnt = '201801';
DEFINE end_wk_idnt = '201828';
DEFINE week = '2018';
set worksheetname incremental_email_&week;

drop table weekly_emailed;
drop table weekly_control_us;
drop table weekly_control_can;

select 
count(distinct indiv_id)
from weekly_control_can 


--create table of all email ids, and us or canada from contact history
create table weekly_emailed  as
select distinct
   hist.wk_idnt                                   as wk_idnt,
   rf.indiv_id                                       as indiv_id,
   rf.ca_valid_email_flg                 as canada,
   min(opened_dt)                          as first_open
from         ua_email_contact_history hist
  inner join ua_campaign              camp  on hist.campaign_src_cd = camp.campaign_src_cd  and hist.campaign_id = camp.campaign_id
  inner join ua_email_ref             rf    on hist.email_id        = rf.email_id and rf.pref_indiv_em_flg = 'Y' 
  inner join ua_email_resolution      res   on hist.contact_urn     = res.contact_urn
  inner join ua_pos_tm_day tm on   to_date(camp.start_dt) = tm.day_dt
where tm.wk_idnt between &start_wk_idnt and &end_wk_idnt
and res.wk_idnt between &start_wk_idnt and &end_wk_idnt
and  rf.ca_valid_email_flg   ='Y'
group by hist.wk_idnt, rf.indiv_id, rf.ca_valid_email_flg
order by hist.wk_idnt;

create table weekly_control_us as
select distinct 
ctrl.indiv_id                                        as indiv_id,
tm.wk_idnt+1                                 as wk_idnt
from  unica.tmp_us_weekly_control_hh ctrl
inner join  ua_pos_tm_day tm on to_date((substr(rundate, 1, 9))) = tm.day_dt
  where tm.wk_idnt+1 between &start_wk_idnt and &end_wk_idnt
  and ctrl.indiv_id||tm.wk_idnt+1 not in (select indiv_id||wk_idnt from weekly_emailed);

drop table weekly_control_can;

create table weekly_control_can as
select distinct 
ind.indiv_id                                         as indiv_id,
tm.wk_idnt+1                                  as wk_idnt
from  unica.tmp_can_weekly_control_hh ctrl
inner join  ua_pos_tm_day tm on to_date((substr(rundate, 1, 9))) = tm.day_dt
inner join ua_individual ind on ind.hh_id=ctrl.hh_id
  where tm.wk_idnt+1 between &start_wk_idnt and &end_wk_idnt
  and ctrl.indiv_id||tm.wk_idnt+1 not in (select indiv_id||wk_idnt from weekly_emailed)
  and ctrl.indiv_id in (select indiv_id from ua_email_ref);
  
  select * from unica.tmp_can_weekly_control_hh ctrl where rownum <100
  
select * from ua_email_ref where rownum <100

select 
count(distinct indiv_id) as customers, 
wk_idnt
from weekly_control_can
group by wk_idnt
order by wk_idnt;

  --emailed sales for US
SELECT 
emailed.wk_idnt,
count(distinct emailed.indiv_id)                                                                                                                                                                                                           as emailed_customers,
count(distinct(coalesce (stre.indiv_id, ecom.indiv_id)))                                                                                                                                                             as shopping_customers,
sum((coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)))                                                                                                                                 as trans,
sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))                                                                                                                                 as sales,
(round(sum(stre.store_gm)/sum(stre.store_sales), 4)) *   sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))            as gm
from weekly_emailed emailed
left join (
          select
          dtl.wk_idnt,
          emailed.indiv_id,
          count(distinct dtl.pos_trans_key)                   as store_trans,
          sum(dtl.extended_sls_amt)                              as store_sales,
          sum(dtl.grs_mrgn_amt)                                       as store_gm,
          sum(dtl.qty)                                                              as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
        inner join ua_pos_tm_day tm on dtl.day_idnt= tm.day_idnt
         inner join weekly_emailed  emailed  on dtl.indiv_id = emailed.indiv_id and emailed.wk_idnt = dtl.wk_idnt and emailed.canada = 'N' and to_date(emailed.first_open)<=tm.day_dt 
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
         and str.loc_cntry_desc = 'USA'
        group by emailed.indiv_id, dtl.wk_idnt)stre on emailed.indiv_id = stre.indiv_id and emailed.wk_idnt=stre.wk_idnt
   left join(
    select
        tm.wk_idnt,
        emailed.indiv_id,
        count(distinct ecom.order_id)                         as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                            as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                    as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
         inner join weekly_emailed  emailed  on ecom.indiv_id = emailed.indiv_id and emailed.wk_idnt = tm.wk_idnt and  emailed.canada = 'N' and to_date(emailed.first_open)<=tm.day_dt 
        where tm.wk_idnt between  &start_wk_idnt and &end_wk_idnt
        group by emailed.indiv_id, tm.wk_idnt) ecom on emailed.indiv_id = ecom.indiv_id and emailed.wk_idnt = ecom.wk_idnt
where emailed.wk_idnt between &start_wk_idnt and &end_wk_idnt and emailed.canada = 'N'
group by emailed.wk_idnt
order by emailed.wk_idnt;

  --control group sales for US
SELECT 
emailed.wk_idnt,
count(distinct emailed.indiv_id)                                                                                                                                                                                                           as emailed_customers,
count(distinct(coalesce (stre.indiv_id, ecom.indiv_id)))                                                                                                                                                             as shopping_customers,
sum((coalesce(stre.store_trans,0))+ (coalesce(ecom.ecom_trans, 0)))                                                                                                                                 as trans,
sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))                                                                                                                                 as sales,
(round(sum(stre.store_gm)/sum(stre.store_sales), 4)) *   sum((coalesce(stre.store_sales,0))+ (coalesce(ecom.ecom_sales, 0)))            as gm
from  weekly_control_us  emailed
left join (
          select
          dtl.wk_idnt,
          emailed.indiv_id,
          count(distinct dtl.pos_trans_key)                   as store_trans,
          sum(dtl.extended_sls_amt)                              as store_sales,
          sum(dtl.grs_mrgn_amt)                                       as store_gm,
          sum(dtl.qty)                                                              as store_units
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
        inner join ua_pos_tm_day tm on dtl.day_idnt= tm.day_idnt
         inner join  weekly_control_us  emailed  on dtl.indiv_id = emailed.indiv_id and emailed.wk_idnt = dtl.wk_idnt 
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'
          and str.loc_cntry_desc = 'USA'
        group by emailed.indiv_id, dtl.wk_idnt)stre on emailed.indiv_id = stre.indiv_id and emailed.wk_idnt=stre.wk_idnt
   left join(
    select
        tm.wk_idnt,
        emailed.indiv_id,
        count(distinct ecom.order_id)                         as ecom_trans,
        sum(ecom.flfll_net_ttl_amt)                            as ecom_sales,
        sum(ecom.flfll_unit_cnt)                                    as ecom_units
        from ua_ecom_order_dtl   ecom
        inner join ua_pos_tm_day tm on to_date(ecom.flfll_first_dt) = (tm.day_dt)
         inner join  weekly_control_us  emailed  on ecom.indiv_id = emailed.indiv_id and emailed.wk_idnt = tm.wk_idnt 
        where tm.wk_idnt between  &start_wk_idnt and &end_wk_idnt
        group by emailed.indiv_id, tm.wk_idnt) ecom on emailed.indiv_id = ecom.indiv_id and emailed.wk_idnt = ecom.wk_idnt
where emailed.wk_idnt between &start_wk_idnt and &end_wk_idnt
group by emailed.wk_idnt
order by emailed.wk_idnt;

--openers for US and Canada
select
wk_idnt,
canada,
count(distinct indiv_id) as openers
from weekly_emailed
where wk_idnt  between 201828 and 201828
and first_open is not null
group by  canada, wk_idnt
order by canada, wk_idnt;

--control canada
SELECT 
con.wk_idnt,
count(distinct con.indiv_id)                                                                                                                                                                                                                   as emailed_customers,
count(distinct stre.indiv_id)                                                                                                                                                                                                                   as shopping_customers,
sum(stre.store_trans)                                                                                                                                                                                                                                as trans,
sum(stre.store_sales)                                                                                                                                                                                                                                as sales,
sum(stre.store_gm)                                                                                                                                                                                                                                    as gm
from  weekly_control_can con
left join (select
            con.wk_idnt,   
           dtl.indiv_id                                                              as indiv_id,
          count(distinct dtl.pos_trans_key)                   as store_trans,
          sum(dtl.extended_sls_amt)                              as store_sales,
          sum(dtl.grs_mrgn_amt)                                       as store_gm
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
        inner join ua_pos_tm_day tm on dtl.day_idnt= tm.day_idnt
         inner join weekly_control_can con  on dtl.indiv_id = con.indiv_id and con.wk_idnt = dtl.wk_idnt 
         where dtl.wk_idnt between &start_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999'  
         and str.loc_cntry_desc = 'CANADA'
        group by dtl.indiv_id, con.wk_idnt) stre on con.indiv_id = stre.indiv_id and con.wk_idnt =stre.wk_idnt
where con.wk_idnt between &start_wk_idnt and  &end_wk_idnt
group by con.wk_idnt
order by con.wk_idnt;

--emailed canada
SELECT 
emailed.wk_idnt,
count(distinct emailed.indiv_id)                                                                                                                                                                                                          as emailed_customers,
count(distinct stre.indiv_id)                                                                                                                                                                                                                   as shopping_customers,
sum(stre.store_trans)                                                                                                                                                                                                                                as trans,
sum(stre.store_sales)                                                                                                                                                                                                                                as sales,
sum(stre.store_gm)                                                                                                                                                                                                                                    as gm
from  weekly_emailed emailed
left join (select
           dtl.indiv_id                                                              as indiv_id,
          count(distinct dtl.pos_trans_key)                   as store_trans,
          sum(dtl.extended_sls_amt)                              as store_sales,
          sum(dtl.grs_mrgn_amt)                                       as store_gm
         from         ua_pos_trans_dtl dtl
         inner join ua_store str on dtl.loc_key = str.loc_key
        inner join ua_pos_tm_day tm on dtl.day_idnt= tm.day_idnt
         inner join weekly_emailed emailed  on dtl.indiv_id = emailed.indiv_id and emailed.wk_idnt = dtl.wk_idnt 
         where dtl.wk_idnt between &end_wk_idnt and &end_wk_idnt and dtl.trans_typ_key in(19,22,33) and str.distt_idnt != '999' and to_DATE(emailed.first_open)<=tm.day_dt 
         and emailed.canada= 'Y'
         and str.loc_cntry_desc = 'CANADA'
        group by dtl.indiv_id) stre on emailed.indiv_id = stre.indiv_id
where emailed.wk_idnt =  &end_wk_idnt and emailed.canada= 'Y'
group by emailed.wk_idnt
order by emailed.wk_idnt asc;

drop table customer_clicks;
drop table email_product_groups_ecom;
drop table email_product_groups;

create table customer_clicks as 
select
distinct
offer.offer_name                                                        as offer_name,
rf.indiv_id                                                                      as indiv_id,
click.contact_urn||offer.offer_name                as contact_urn_offer_name,
click.contact_urn                                                         as contact_urn,
max(tm.day_idnt)                                                       as last_click
from  unica.ua_email_click click
inner join unica.ua_campaign_offer offer on offer.offer_id = click.offer_id
inner join ua_pos_tm_day tm on to_date(click.trans_dt)= tm.day_dt
inner join ua_email_ref rf on click.email_id = rf.email_id and rf.pref_indiv_em_flg = 'Y' and rf.valid_email_mktg_flg = 'Y' and rf.ca_valid_email_flg = 'N' and rf.VALID_ADDR_PREF_INDIV_EM_FLG ='Y'
where click.wk_idnt = &end_wk_idnt  and offer.channel= 'EMAIL'
group by offer.offer_name, rf.indiv_id,  click.contact_urn;

--store products
Create table email_product_groups_ecom as
select
distinct
clicks.contact_urn||clicks.offer_name as contact_urn_offer_name,  
clicks.offer_name,
sku.div_desc, 
sku.grp_desc, 
sku.class_desc, 
sku.sbclass_desc,
(case
when ((UPPER(clicks.offer_name)) like '%CUSTOM FRAM%' or (UPPER(clicks.offer_name)) like '%CUSTOM-FRAM%'or (UPPER(clicks.offer_name)) like '%SCOTT BROTHERS%') and sku.grp_desc like '%CUSTOM FRAMING%' then sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%FRAME%' or (UPPER(clicks.offer_name)) like'%SHADOW BOXES%' or (UPPER(clicks.offer_name)) like'%DISPLAY CASES%') and sku.grp_desc like '%FRAMES%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CRICUT%'                                                              and sku.class_desc like '%CRICUT%'             then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CRAYOLA%'                                                             and sku.sbclass_desc like '%CRAYOLA%'          then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%YARN%'                                                                and sku.class_desc like '%YARN%'               then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%PATRICK%'                                                             and sku.sbclass_desc like '%PATRICK%'          then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%VALENTINE%'                                                           and sku.sbclass_desc like '%VALENTINE%'        then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CHRISTMAS%'                                                           and sku.sbclass_desc like '%CHRISTMAS%'        then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%HALLOWEEN%'                                                           and sku.sbclass_desc like '%HALLOWEEN%'        then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%EASTER%'                                                              and sku.sbclass_desc like '%EASTER%'           then sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%WEDDING%' or (UPPER(clicks.offer_name)) like '%BRIDAL%' or (UPPER(clicks.offer_name)) like '%YOUR BIG DAY%') and sku.class_desc like '%WEDDING%' then sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like'%STORAG%' or (UPPER(clicks.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(clicks.offer_name)) like '%ORGANIZATION%') and sku.class_desc like '%STORAGE%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%DECORATIVE BOX%'                                                      and sku.grp_desc like '%DECORATIVE BOX%'       then  sum(ecom.dmnd_net_ttl_amt)
when ((LOWER(clicks.offer_name)) like '%dï¿½cor%'or (UPPER(clicks.offer_name)) like '%DECOR%')and (UPPER(clicks.offer_name)) not like '%DECORAT%'and (UPPER(clicks.offer_name)) like '%FLORAL%' and (sku.class_desc like '%DECOR%' or sku.grp_desc like '%FLORAL%') then  sum(ecom.dmnd_net_ttl_amt)
when ((LOWER(clicks.offer_name)) like '%%dï¿½cor%' or (UPPER(clicks.offer_name)) like '%DECOR%') and (UPPER(clicks.offer_name)) not like '%DECORAT%'and sku.class_desc like '%DECOR%' then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%FLORAL%' or (UPPER(clicks.offer_name)) like '%BUSHES%' or (UPPER(clicks.offer_name)) like '%WREATHS%' or (UPPER(clicks.offer_name)) like '%GARDEN%') and sku.grp_desc like '%FLORAL%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CANVAS%'                                                              and sku.class_desc like  '061 CANVAS%'         then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%RIBBON%'                                                              and sku.class_desc like  '%RIBBON%'            then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%BEADS%'                                                               and sku.class_desc like '%BEADS%'              then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%LIGHTING%'                                                            and sku.class_desc like '%LIGHTING%'           then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%MINIATURE%' or (UPPER(clicks.offer_name)) like '%MINIS%')              and sku.class_desc like '%MINIATURE%'        then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%SEWING%'                                                              and sku.class_desc like '%SEWING%'             then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%ART SUPPLIES%'                                                        and sku.grp_desc like '%ART SUPPLIES%'         then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%JEWELRY%' or (UPPER(clicks.offer_name)) like '%WATCH%' or (UPPER(clicks.offer_name)) like '%BRACELET%' or (UPPER(clicks.offer_name)) like '%NECKLACE%') and sku.class_desc like '%JEWELRY%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%KIDS%'                                                                and sku.grp_desc like '%KIDS%'                 then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%KNITTING%' or (UPPER(clicks.offer_name)) like '%CROCHET%' or (UPPER(clicks.offer_name)) like '%NEEDLE%') and sku.grp_desc like '%NEEDLE%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%WASHI%'                                                               and sku.sbclass_desc like '%WASHI%'            then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%PLANNER%'                                                             and sku.class_desc like '%PLANNER%'            then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%PAPERCRAFT%'   or  (UPPER(clicks.offer_name)) like '%PAPER CRAFT%' ) and sku.grp_desc like '%PAPERCRAFT%'           then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CANDLE%'                                                              and sku.grp_desc like '%CANDLE%'               then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%BAKING%' or (UPPER(clicks.offer_name)) like '%WILTON%' or (UPPER(clicks.offer_name)) like '%FONDANT%' or (UPPER(clicks.offer_name)) like '%CUPCAKES%') and sku.grp_desc like '%FOOD CRAFT%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%T-SHIRTS%'                                                            and sku.class_desc like '%TSHIRT%'             then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%PAPER PADS%' or (UPPER(clicks.offer_name)) like'%PAINT%' or (UPPER(clicks.offer_name)) like '%PEN %'or (UPPER(clicks.offer_name)) like '%PENCIL%' or (UPPER(clicks.offer_name)) like '%EASEL%' or (UPPER(clicks.offer_name)) like '%FOOTER ART%') and sku.grp_desc like '%ART SUPPLIES%' then sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%DRAFTING TABLE%'                                                      and sku.sbclass_desc like '%DRAFTING TABLE%'   then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%SEASONAL%' or (UPPER(clicks.offer_name)) like'%SPRING%')              and sku.div_desc like '%SEASONAL%'             then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CRAFT%'                                                               and sku.class_desc like '%GENERAL CRAFT%'      then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%GLUE%'                                                                and sku.sbclass_desc like '%GLUE%'             then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%PHOTO BOXES%'                                                         and sku.sbclass_desc like '%PHOTO BOXES%'      then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%POM POM%'                                                             and sku.sbclass_desc like '%POM POM%'          then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%SCRAPBOOK%'                                                           and sku.sbclass_desc like '%SCRPBOOK%'         then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%JAR%'                                                                 and sku.sbclass_desc like '%JARS%'             then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%METAL STAMPING%'                                                      and sku.sbclass_desc like '%METAL STAMPING%'   then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%CHARGER%'                                                             and sku.class_desc like '%CHARGER%'            then  sum(ecom.dmnd_net_ttl_amt)
when (UPPER(clicks.offer_name)) like '%SLIME%'                                                               and sku.class_desc like '%CRAFT ADHESIVE%'     then  sum(ecom.dmnd_net_ttl_amt)
when ((UPPER(clicks.offer_name)) like '%OFF ANY ONE REGULAR PRICE%'  or (UPPER(clicks.offer_name)) like  '%ANY ONE REGULAR PRICE ITEM%' or (UPPER(clicks.offer_name)) like '%EXTRA 20% OFF ALMOST EVERYTHIN%' or (UPPER(clicks.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(clicks.offer_name)) like '%COUPON%' or (UPPER(clicks.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(clicks.offer_name)) like '%OFF ENTIRE REGULAR PRICE%') and ecom.promoid is not null then sum(ecom.dmnd_net_ttl_amt)
else null end)                                                as division_sales,
(case 
when ((UPPER(clicks.offer_name)) like '%CUSTOM FRAM%' or (UPPER(clicks.offer_name)) like '%CUSTOM-FRAM%' or (UPPER(clicks.offer_name)) like '%SCOTT BROTHERS%') then 'custom framing'
when ((UPPER(clicks.offer_name)) like '%FRAME%' or (UPPER(clicks.offer_name)) like'%SHADOW BOXES%' or (UPPER(clicks.offer_name)) like'%DISPLAY CASES%')       then 'frames'
when (UPPER(clicks.offer_name)) like '%CRICUT%'                                                                                                             then 'cricut'
when (UPPER(clicks.offer_name)) like '%CRAYOLA%'                                                                                                            then 'crayola'
when (UPPER(clicks.offer_name)) like '%YARN%'                                                                                                               then 'yarn'
when (UPPER(clicks.offer_name)) like '%PATRICK%'                                                                                                            then 'st.patricks day'
when (UPPER(clicks.offer_name)) like '%VALENTINE%'                                                                                                          then 'valentine'
when (UPPER(clicks.offer_name)) like '%CHRISTMAS%'                                                                                                          then 'christmas'
when (UPPER(clicks.offer_name)) like '%HALLOWEEN%'                                                                                                          then 'halloween'
when (UPPER(clicks.offer_name)) like '%EASTER%'                                                                                                             then 'easter'
when ((UPPER(clicks.offer_name)) like '%WEDDING%' or (UPPER(clicks.offer_name)) like '%BRIDAL%' or (UPPER(clicks.offer_name)) like '%YOUR BIG DAY%')          then 'wedding'
when ((UPPER(clicks.offer_name)) like '%STORAGE%' or (UPPER(clicks.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(clicks.offer_name)) like '%ORGANIZATION%') then 'craft storage'
when (UPPER(clicks.offer_name)) like '%DECORATIVE BOX%'                                                                                                     then 'decorative boxes'
when ((LOWER(clicks.offer_name)) like '%dï¿½cor%'or (UPPER(clicks.offer_name)) like '%DECOR%' )and (UPPER(clicks.offer_name)) not like '%DECORAT%' and (UPPER(clicks.offer_name)) like '%FLORAL%' then 'floral and decor'
when ((LOWER(clicks.offer_name)) like '%%dï¿½cor%'or (UPPER(clicks.offer_name)) like '%DECOR%') and (UPPER(clicks.offer_name)) not like '%DECORAT%'             then 'decor'
when ((UPPER(clicks.offer_name)) like '%FLORAL%' or (UPPER(clicks.offer_name)) like '%BUSHES%' or (UPPER(clicks.offer_name)) like '%WREATH%' or (UPPER(clicks.offer_name)) like '%GARDEN%') then 'floral'
when (UPPER(clicks.offer_name)) like '%CANVAS%'                                                                                                             then 'canvas'
when (UPPER(clicks.offer_name)) like '%RIBBON%'                                                                                                             then 'ribbon'
when (UPPER(clicks.offer_name)) like '%BEADS%'                                                                                                              then 'beads'
when (UPPER(clicks.offer_name)) like '%LIGHTING%'                                                                                                           then 'lighting'
when ((UPPER(clicks.offer_name)) like '%MINIATURE%' or (UPPER(clicks.offer_name)) like '%MINIS%')                                                             then 'miniature'
when (UPPER(clicks.offer_name)) like '%SEWING%'                                                                                                             then 'sewing'
when (UPPER(clicks.offer_name)) like '%ART SUPPLIES%'                                                                                                       then 'art supplies'
when ((UPPER(clicks.offer_name)) like '%JEWELRY%' or (UPPER(clicks.offer_name)) like '%WATCH%' or (UPPER(clicks.offer_name)) like '%BRACELET%' or (UPPER(clicks.offer_name)) like '%NECKLACE%') then 'jewelry'
when (UPPER(clicks.offer_name)) like '%KIDS%'                                                                                                               then 'kids'
when ((UPPER(clicks.offer_name)) like '%KNITTING%' or (UPPER(clicks.offer_name)) like '%CROCHET%' or (UPPER(clicks.offer_name)) like '%NEEDLE%')              then 'knitting and needle crafts'
when (UPPER(clicks.offer_name)) like '%WASHI%'                                                                                                              then 'washi'
when (UPPER(clicks.offer_name)) like '%PLANNER%'                                                                                                            then 'planners'
when ((UPPER(clicks.offer_name)) like '%PAPERCRAFT%'   or  (UPPER(clicks.offer_name)) like '%PAPER CRAFT%' )                                                                                                       then 'papercrafting'
when (UPPER(clicks.offer_name)) like '%CANDLE%'                                                                                                             then 'candle'
when ((UPPER(clicks.offer_name)) like '%BAKING%' or (UPPER(clicks.offer_name)) like '%WILTON%'or (UPPER(clicks.offer_name)) like '%FONDANT%' or (UPPER(clicks.offer_name)) like '%CUPCAKES%')               then 'baking'
when (UPPER(clicks.offer_name)) like '%T-SHIRTS%'                                                                                                           then 'tshirts'
when ((UPPER(clicks.offer_name)) like '%PAPER PADS%' or (UPPER(clicks.offer_name)) like'%PAINT%' or (UPPER(clicks.offer_name)) like '%PEN %'or (UPPER(clicks.offer_name)) like '%PENCIL%'  or (UPPER(clicks.offer_name)) like '%EASEL%' or (UPPER(clicks.offer_name)) like '%FOOTER ART%') then 'art supplies'
when (UPPER(clicks.offer_name)) like '%DRAFTING TABLE%'                                                                                                     then 'drafting tables'
when ((UPPER(clicks.offer_name)) like '%SEASONAL%' or (UPPER(clicks.offer_name)) like'%SPRING%')                                                             then 'seasonal'
when (UPPER(clicks.offer_name)) like '%CRAFT%'                                                                                                              then 'general crafts'
when (UPPER(clicks.offer_name)) like '%GLUE%'                                                                                                               then 'glue'
when (UPPER(clicks.offer_name)) like '%PHOTO BOXES%'                                                                                                        then 'photo boxes'
when (UPPER(clicks.offer_name)) like '%POM POM%'                                                                                                            then 'pom poms'
when (UPPER(clicks.offer_name)) like '%SCRAPBOOK%'                                                                                                          then 'scrapbook'
when (UPPER(clicks.offer_name)) like '%JAR%'                                                                                                                then 'jar'
when (UPPER(clicks.offer_name)) like '%METAL STAMPING%'                                                                                                     then 'metal stamping'
when (UPPER(clicks.offer_name)) like '%CHARGER%'                                                                                                            then 'charger'
when (UPPER(clicks.offer_name)) like '%SLIME%'                                                                                                              then 'slime'
when ((UPPER(clicks.offer_name)) like '%OFF ANY ONE REGULAR PRICE%' or (UPPER(clicks.offer_name)) like  '%ANY ONE REGULAR PRICE ITEM%'  or (UPPER(clicks.offer_name)) like '%EXTRA 20% OFF ALMOST EVERYTHIN%' or (UPPER(clicks.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(clicks.offer_name)) like '%COUPON%'or (UPPER(clicks.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(clicks.offer_name)) like '%OFF ENTIRE REGULAR PRICE%') then 'coupon'
else null end)                                                                                                                                             as division_group
from  customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.last_click = tm.day_idnt
inner join ua_ecom_order_dtl ecom on clicks.indiv_id = ecom.indiv_id and to_date(ecom.dmnd_dt) = tm.day_dt
left join ua_pos_prod_sku sku on ecom.sku_name = sku.sku_idnt
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
and ecom.line_item_type = 'DEMAND'
group by clicks.contact_urn, clicks.offer_name, sku.div_desc, sku.grp_desc, sku.class_desc, sku.sbclass_desc, ecom.promoid;


--store orders
Create table email_product_groups as
select
distinct
click.contact_urn||click.offer_name as contact_urn_offer_name,  
click.offer_name,
sku.div_desc, 
sku.grp_desc, 
sku.class_desc, 
sku.sbclass_desc,
(case
when ((UPPER(click.offer_name)) like '%CUSTOM FRAM%' or (UPPER(click.offer_name)) like '%CUSTOM-FRAM%'or (UPPER(click.offer_name)) like '%SCOTT BROTHERS%') and sku.grp_desc like '%CUSTOM FRAMING%' then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%FRAME%' or (UPPER(click.offer_name)) like'%SHADOW BOXES%' or (UPPER(click.offer_name)) like'%DISPLAY CASES%') and sku.grp_desc like '%FRAMES%' then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CRICUT%'                                                              and sku.class_desc like '%CRICUT%'             then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CRAYOLA%'                                                             and sku.sbclass_desc like '%CRAYOLA%'          then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%YARN%'                                                                and sku.class_desc like '%YARN%'               then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%PATRICK%'                                                             and sku.sbclass_desc like '%PATRICK%'          then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%VALENTINE%'                                                           and sku.sbclass_desc like '%VALENTINE%'        then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CHRISTMAS%'                                                           and sku.sbclass_desc like '%CHRISTMAS%'        then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%HALLOWEEN%'                                                           and sku.sbclass_desc like '%HALLOWEEN%'        then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%EASTER%'                                                              and sku.sbclass_desc like '%EASTER%'           then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%WEDDING%' or (UPPER(click.offer_name)) like '%BRIDAL%' or (UPPER(click.offer_name)) like '%YOUR BIG DAY%') and sku.class_desc like '%WEDDING%'            then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like'%STORAG%' or (UPPER(click.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(click.offer_name)) like '%ORGANIZATION%') and sku.class_desc like '%STORAGE%' then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%DECORATIVE BOX%'                                                      and sku.grp_desc like '%DECORATIVE BOX%'       then sum(dtl.extended_sls_amt)
when ((LOWER(click.offer_name)) like '%dï¿½cor%'or (UPPER(click.offer_name)) like '%DECOR%')and (UPPER(click.offer_name)) not like '%DECORAT%'and (UPPER(click.offer_name)) like '%FLORAL%' and (sku.class_desc like '%DECOR%' or sku.grp_desc like '%FLORAL%')  then sum(dtl.extended_sls_amt)
when ((LOWER(click.offer_name)) like '%%dï¿½cor%' or (UPPER(click.offer_name)) like '%DECOR%') and (UPPER(click.offer_name)) not like '%DECORAT%'and sku.class_desc like '%DECOR%' then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%FLORAL%' or (UPPER(click.offer_name)) like '%BUSHES%' or (UPPER(click.offer_name)) like '%WREATHS%' or (UPPER(click.offer_name)) like '%GARDEN%') and sku.grp_desc like '%FLORAL%' then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CANVAS%'                                                              and sku.class_desc like  '061 CANVAS%'         then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%RIBBON%'                                                              and sku.class_desc like  '%RIBBON%'            then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%BEADS%'                                                               and sku.class_desc like '%BEADS%'              then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%LIGHTING%'                                                            and sku.class_desc like '%LIGHTING%'           then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%MINIATURE%' or (UPPER(click.offer_name)) like '%MINIS%')              and sku.class_desc like '%MINIATURE%'          then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%SEWING%'                                                              and sku.class_desc like '%SEWING%'             then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%ART SUPPLIES%'                                                        and sku.grp_desc like '%ART SUPPLIES%'         then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%JEWELRY%' or (UPPER(click.offer_name)) like '%WATCH%' or (UPPER(click.offer_name)) like '%BRACELET%' or (UPPER(click.offer_name)) like '%NECKLACE%') and sku.class_desc like '%JEWELRY%'            then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%KIDS%'                                                                and sku.grp_desc like '%KIDS%'                 then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%KNITTING%' or (UPPER(click.offer_name)) like '%CROCHET%' or (UPPER(click.offer_name)) like '%NEEDLE%') and sku.grp_desc like '%NEEDLE%' then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%WASHI%'                                                               and sku.sbclass_desc like '%WASHI%'            then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%PLANNER%'                                                             and sku.class_desc like '%PLANNER%'            then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%PAPERCRAFT%'   or  (UPPER(click.offer_name)) like '%PAPER CRAFT%' )                                                        and sku.grp_desc like '%PAPERCRAFT%'           then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CANDLE%'                                                              and sku.grp_desc like '%CANDLE%'               then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%BAKING%' or (UPPER(click.offer_name)) like '%WILTON%' or (UPPER(click.offer_name)) like '%FONDANT%' or (UPPER(click.offer_name)) like '%CUPCAKES%') and sku.grp_desc like '%FOOD CRAFT%'           then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%T-SHIRTS%'                                                            and sku.class_desc like '%TSHIRT%'             then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%PAPER PADS%' or (UPPER(click.offer_name)) like'%PAINT%' or (UPPER(click.offer_name)) like '%PEN %'or (UPPER(click.offer_name)) like '%PENCIL%' or (UPPER(click.offer_name)) like '%EASEL%' or (UPPER(click.offer_name)) like '%FOOTER ART%') and sku.grp_desc like '%ART SUPPLIES%' then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%DRAFTING TABLE%'                                                      and sku.sbclass_desc like '%DRAFTING TABLE%'   then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%SEASONAL%' or (UPPER(click.offer_name)) like'%SPRING%')              and sku.div_desc like '%SEASONAL%'             then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CRAFT%'                                                               and sku.class_desc like '%GENERAL CRAFT%'      then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%GLUE%'                                                                and sku.sbclass_desc like '%GLUE%'             then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%PHOTO BOXES%'                                                         and sku.sbclass_desc like '%PHOTO BOXES%'      then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%POM POM%'                                                             and sku.sbclass_desc like '%POM POM%'          then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%SCRAPBOOK%'                                                           and sku.sbclass_desc like '%SCRPBOOK%'         then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%JAR%'                                                                 and sku.sbclass_desc like '%JARS%'             then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%METAL STAMPING%'                                                      and sku.sbclass_desc like '%METAL STAMPING%'   then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%CHARGER%'                                                             and sku.class_desc like '%CHARGER%'            then sum(dtl.extended_sls_amt)
when (UPPER(click.offer_name)) like '%SLIME%'                                                               and sku.class_desc like '%CRAFT ADHESIVE%'     then sum(dtl.extended_sls_amt)
when ((UPPER(click.offer_name)) like '%OFF ANY ONE REGULAR PRICE%'  or (UPPER(click.offer_name)) like  '%ANY ONE REGULAR PRICE ITEM%'  or (UPPER(click.offer_name)) like '%EXTRA 20% OFF ALMOST EVERYTHIN%' or (UPPER(click.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(click.offer_name)) like '%COUPON%'or (UPPER(click.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(click.offer_name)) like '%OFF ENTIRE REGULAR PRICE%') then sum(cpn.extended_sls_amt)
else null end)                                                as division_sales,
(case 
when ((UPPER(click.offer_name)) like '%CUSTOM FRAM%' or (UPPER(click.offer_name)) like '%CUSTOM-FRAM%' or (UPPER(click.offer_name)) like '%SCOTT BROTHERS%') then 'custom framing'
when ((UPPER(click.offer_name)) like '%FRAME%' or (UPPER(click.offer_name)) like'%SHADOW BOXES%' or (UPPER(click.offer_name)) like'%DISPLAY CASES%')       then 'frames'
when (UPPER(click.offer_name)) like '%CRICUT%'                                                                                                             then 'cricut'
when (UPPER(click.offer_name)) like '%CRAYOLA%'                                                                                                            then 'crayola'
when (UPPER(click.offer_name)) like '%YARN%'                                                                                                               then 'yarn'
when (UPPER(click.offer_name)) like '%PATRICK%'                                                                                                            then 'st.patricks day'
when (UPPER(click.offer_name)) like '%VALENTINE%'                                                                                                          then 'valentine'
when (UPPER(click.offer_name)) like '%CHRISTMAS%'                                                                                                          then 'christmas'
when (UPPER(click.offer_name)) like '%HALLOWEEN%'                                                                                                          then 'halloween'
when (UPPER(click.offer_name)) like '%EASTER%'                                                                                                             then 'easter'
when ((UPPER(click.offer_name)) like '%WEDDING%' or (UPPER(click.offer_name)) like '%BRIDAL%' or (UPPER(click.offer_name)) like '%YOUR BIG DAY%')          then 'wedding'
when ((UPPER(click.offer_name)) like '%STORAGE%' or (UPPER(click.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(click.offer_name)) like '%ORGANIZATION%') then 'craft storage'
when (UPPER(click.offer_name)) like '%DECORATIVE BOX%'                                                                                                     then 'decorative boxes'
when ((LOWER(click.offer_name)) like '%dï¿½cor%'or (UPPER(click.offer_name)) like '%DECOR%' )and (UPPER(click.offer_name)) not like '%DECORAT%' and (UPPER(click.offer_name)) like '%FLORAL%' then 'floral and decor'
when ((LOWER(click.offer_name)) like '%%dï¿½cor%'or (UPPER(click.offer_name)) like '%DECOR%') and (UPPER(click.offer_name)) not like '%DECORAT%'             then 'decor'
when ((UPPER(click.offer_name)) like '%FLORAL%' or (UPPER(click.offer_name)) like '%BUSHES%' or (UPPER(click.offer_name)) like '%WREATH%' or (UPPER(click.offer_name)) like '%GARDEN%') then 'floral'
when (UPPER(click.offer_name)) like '%CANVAS%'                                                                                                             then 'canvas'
when (UPPER(click.offer_name)) like '%RIBBON%'                                                                                                             then 'ribbon'
when (UPPER(click.offer_name)) like '%BEADS%'                                                                                                              then 'beads'
when (UPPER(click.offer_name)) like '%LIGHTING%'                                                                                                           then 'lighting'
when ((UPPER(click.offer_name)) like '%MINIATURE%' or (UPPER(click.offer_name)) like '%MINIS%')                                                             then 'miniature'
when (UPPER(click.offer_name)) like '%SEWING%'                                                                                                             then 'sewing'
when (UPPER(click.offer_name)) like '%ART SUPPLIES%'                                                                                                       then 'art supplies'
when ((UPPER(click.offer_name)) like '%JEWELRY%' or (UPPER(click.offer_name)) like '%WATCH%' or (UPPER(click.offer_name)) like '%BRACELET%' or (UPPER(click.offer_name)) like '%NECKLACE%') then 'jewelry'
when (UPPER(click.offer_name)) like '%KIDS%'                                                                                                               then 'kids'
when ((UPPER(click.offer_name)) like '%KNITTING%' or (UPPER(click.offer_name)) like '%CROCHET%' or (UPPER(click.offer_name)) like '%NEEDLE%')              then 'knitting and needle crafts'
when (UPPER(click.offer_name)) like '%WASHI%'                                                                                                              then 'washi'
when (UPPER(click.offer_name)) like '%PLANNER%'                                                                                                            then 'planners'
when  ((UPPER(click.offer_name)) like '%PAPERCRAFT%'   or  (UPPER(click.offer_name)) like '%PAPER CRAFT%' ) then 'papercrafting'
when (UPPER(click.offer_name)) like '%CANDLE%'                                                                                                             then 'candle'
when ((UPPER(click.offer_name)) like '%BAKING%' or (UPPER(click.offer_name)) like '%WILTON%'or (UPPER(click.offer_name)) like '%FONDANT%' or (UPPER(click.offer_name)) like '%CUPCAKES%')               then 'baking'
when (UPPER(click.offer_name)) like '%T-SHIRTS%'                                                                                                           then 'tshirts'
when ((UPPER(click.offer_name)) like '%PAPER PADS%' or (UPPER(click.offer_name)) like'%PAINT%' or (UPPER(click.offer_name)) like '%PEN %'or (UPPER(click.offer_name)) like '%PENCIL%'  or (UPPER(click.offer_name)) like '%EASEL%' or (UPPER(click.offer_name)) like '%FOOTER ART%') then 'art supplies'
when (UPPER(click.offer_name)) like '%DRAFTING TABLE%'                                                                                                     then 'drafting tables'
when ((UPPER(click.offer_name)) like '%SEASONAL%' or (UPPER(click.offer_name)) like'%SPRING%')                                                             then 'seasonal'
when (UPPER(click.offer_name)) like '%CRAFT%'                                                                                                              then 'general crafts'
when (UPPER(click.offer_name)) like '%GLUE%'                                                                                                               then 'glue'
when (UPPER(click.offer_name)) like '%PHOTO BOXES%'                                                                                                        then 'photo boxes'
when (UPPER(click.offer_name)) like '%POM POM%'                                                                                                            then 'pom poms'
when (UPPER(click.offer_name)) like '%SCRAPBOOK%'                                                                                                          then 'scrapbook'
when (UPPER(click.offer_name)) like '%JAR%'                                                                                                                then 'jar'
when (UPPER(click.offer_name)) like '%METAL STAMPING%'                                                                                                     then 'metal stamping'
when (UPPER(click.offer_name)) like '%CHARGER%'                                                                                                            then 'charger'
when (UPPER(click.offer_name)) like '%SLIME%'                                                                                                              then 'slime'
when ((UPPER(click.offer_name)) like '%OFF ANY ONE REGULAR PRICE%' or (UPPER(click.offer_name)) like  '%ANY ONE REGULAR PRICE ITEM%'   or (UPPER(click.offer_name)) like '%EXTRA 20% OFF ALMOST EVERYTHIN%'  or (UPPER(click.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(click.offer_name)) like '%COUPON%' or (UPPER(click.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(click.offer_name)) like '%OFF ENTIRE REGULAR PRICE%' or (UPPER(click.offer_name)) like '%AORPI%') then 'coupon sales'
else null end)                                                                                                                                             as division_group
from  customer_clicks click
inner join ua_pos_tm_day tm on click.last_click = tm.day_idnt
inner join ua_pos_trans_dtl dtl on click.indiv_id = dtl.indiv_id and dtl.day_idnt = tm.day_idnt and dtl.trans_typ_key in(19,22,33)
inner join ua_pos_prod_sku sku on dtl.sku_key = sku.sku_key
inner join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
left join ua_pos_coupon_dtl cpn on dtl.pos_trans_key = cpn.pos_trans_key and dtl.sku_key = cpn.sku_key and dtl.TRANS_DETAIL_SQNC_NBR = cpn.COUPON_SQNC_NBR  
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
group by  click.contact_urn, click.offer_name, sku.div_desc, sku.grp_desc, sku.class_desc, sku.sbclass_desc;


--ecom
select 
(substr(clicks.offer_name, 1, 60))                                                                                                                              as offer_name,
count(distinct clicks.contact_urn)                                                                                                                                               as clicks,
product_ecom.division_group                                                                                                                                     as ecom_product_type,
sum(product_ecom.division_sales)                                                                                                                           as ecom_product_sales
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.last_click= tm.day_idnt
left join  email_product_groups_ecom product_ecom on  clicks.contact_urn_offer_name= product_ecom.contact_urn_offer_name
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
and product_ecom.division_group is not null
group by clicks.offer_name, product_ecom.division_group
order by clicks desc;

--store
select 
(substr(clicks.offer_name, 1, 60))                                                                                                                            as offer_name,
count(distinct clicks.contact_urn)                                                                                                                            as clicks,
product.division_group                                                                                                                                                as store_product_type,
sum(product.division_sales)                                                                                                                                     as store_product_sales
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.last_click= tm.day_idnt
left join  email_product_groups product on clicks.contact_urn_offer_name= product.contact_urn_offer_name
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
and product.division_group is not null
group by clicks.offer_name, product.division_group
order by clicks desc;


select 
(substr(clicks.offer_name, 1, 60))                                                                                                                       as offer_name,
count(distinct clicks.contact_urn)                                                                                                                       as clicks
from customer_clicks clicks
group by clicks.offer_name
order by clicks desc;

--overall sales
--ecom
select 
(substr(clicks.offer_name, 1, 60))                                                                                                                       as offer_name,
count(distinct clicks.contact_urn)                                                                                                                       as clicks,
count(distinct ecom.indiv_id)                                                                                                                               as ecom_customers,
count(distinct ecom.order_id)                                                                                                                              as ecom_trans,
sum(ecom.dmnd_net_ttl_amt)                                                                                                                             as ecom_sales
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.last_click= tm.day_idnt
left join ua_ecom_order_dtl ecom on ecom.indiv_id = clicks.indiv_id and (to_date(ecom.dmnd_dt) = tm.day_dt)  and ecom.line_item_type = 'DEMAND'
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
group by clicks.offer_name
order by clicks desc;

--store
select 
(substr(clicks.offer_name, 1, 60))                                                                                                                          as offer_name,
count(distinct clicks.contact_urn)                                                                                                                                   as clicks,
count(distinct dtl.indiv_id)                                                                                                                                as store_customers,
count(distinct dtl.pos_trans_key)                                                                                                                           as store_trans,
sum(dtl.extended_sls_amt)                                                                                                                                   as store_sales
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.last_click= tm.day_idnt
left join ua_pos_trans_dtl dtl on dtl.indiv_id = clicks.indiv_id and dtl.day_idnt = tm.day_idnt and dtl.trans_typ_key in(19,22,33)
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
where tm.wk_idnt between &end_wk_idnt and &end_wk_idnt 
group by clicks.offer_name
order by clicks desc;

drop table bopis

grant select on bopis to public
