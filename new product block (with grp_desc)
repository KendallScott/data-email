select 
distinct(rundate),
(substr(rundate, 1, 9))   as run_date,
tm.wk_idnt+1
from unica.tmp_us_weekly_control_hh
inner join  ua_pos_tm_day tm on to_date((substr(rundate, 1, 9))) = tm.day_dt
order by rundate desc;
drop table customer_clicks;
create table customer_clicks as 
select
distinct
click.contact_urn||offer.offer_name as contact_urn_offer_name,
offer.offer_name,
rf.indiv_id,
click.contact_urn,
campaign_name,
tm.day_idnt
from  unica.ua_email_click click
inner join unica.ua_campaign_offer offer on offer.offer_id = click.offer_id
inner join ua_pos_tm_day tm on to_date(click.trans_dt)= tm.day_dt
inner join ua_email_ref rf on click.email_id = rf.email_id and rf.pref_indiv_em_flg = 'Y' and rf.valid_email_mktg_flg = 'Y' and rf.ca_valid_email_flg = 'N' and rf.VALID_ADDR_PREF_INDIV_EM_FLG ='Y'
inner join ua_email_resolution res on res.contact_urn = click.contact_urn
inner join ua_campaign camp on camp.campaign_id = res.campaign_id
where click.wk_idnt = 201806
and offer.channel= 'EMAIL';
select * from email_product_groups_ecom;
drop table email_product_groups_ecom;
 SET DEFINE OFF;
 
Create table email_product_groups_ecom as
select
distinct
clicks.contact_urn||clicks.offer_name as contact_urn_offer_name,  
clicks.offer_name,
(case when  sku.grp_desc = '98 NON-MERCHANDISING'    then sum(ecom.dmnd_net_ttl_amt) 
when  sku.grp_desc = 'MINI SEASON'                  then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'PACKAGING & PARTY'            then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'APPAREL CRAFTS'               then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'PAINT & DECO ART'             then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'CHRISTMAS'                    then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'RIBBON &  WEDDING'            then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'JEWELRY & BEADS'              then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'NEEDLE CRAFTS'                then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'WOOD CRAFTS'                  then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'HOME ACCENTS'                 then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'TECH & MARTHA STEWAR'         then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'FOOD CRAFT'                   then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'FRAMES & WALL DECOR'          then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'CANDLES'                      then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'BOOKS & MAGAZINES'            then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'KIDS CRAFTS'                  then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'CELEBRATIONS'                 then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'FLORAL'                       then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'ACCENTS & CONTAINERS'         then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'STORE EVENTS & AS IS'         then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'CUSTOM FLORAL'                then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'SCRAPBOOKING'                 then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = '15 CUSTOM FRAMING'            then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'PAPERCRAFTING'                then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'NON-MERCHANDISING'            then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'UNFINISHED SURFACES'          then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'ART SUPPLIES'                 then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'IMPULSE'                      then sum(ecom.dmnd_net_ttl_amt)
when  sku.grp_desc = 'CUSTOM FRAMING'               then sum(ecom.dmnd_net_ttl_amt)
else null end) as group_sales,
(case when  sku.grp_desc = '98 NON-MERCHANDISING'    then '98 NON-MERCHANDISING' 
when  sku.grp_desc = 'MINI SEASON'                  then 'MINI SEASON' 
when  sku.grp_desc = 'PACKAGING & PARTY'            then 'PACKAGING & PARTY'
when  sku.grp_desc = 'APPAREL CRAFTS'               then 'APPAREL CRAFTS' 
when  sku.grp_desc = 'PAINT & DECO ART'             then 'PAINT & DECO ART'
when  sku.grp_desc = 'CHRISTMAS'                    then 'CHRISTMAS'  
when  sku.grp_desc = 'RIBBON &  WEDDING'            then 'RIBBON &  WEDDING' 
when  sku.grp_desc = 'JEWELRY & BEADS'              then 'JEWELRY & BEADS' 
when  sku.grp_desc = 'NEEDLE CRAFTS'                then 'NEEDLE CRAFTS'
when  sku.grp_desc = 'WOOD CRAFTS'                  then 'WOOD CRAFTS' 
when  sku.grp_desc = 'HOME ACCENTS'                 then 'HOME ACCENTS' 
when  sku.grp_desc = 'TECH & MARTHA STEWAR'         then 'TECH & MARTHA STEWAR' 
when  sku.grp_desc = 'FOOD CRAFT'                   then 'FOOD CRAFT' 
when  sku.grp_desc = 'FRAMES & WALL DECOR'          then 'FRAMES & WALL DECOR' 
when  sku.grp_desc = 'CANDLES'                      then 'CANDLES' 
when  sku.grp_desc = 'BOOKS & MAGAZINES'            then 'BOOKS & MAGAZINES' 
when  sku.grp_desc = 'KIDS CRAFTS'                  then 'KIDS CRAFTS'
when  sku.grp_desc = 'CELEBRATIONS'                 then 'CELEBRATIONS' 
when  sku.grp_desc = 'FLORAL'                       then 'FLORAL'      
when  sku.grp_desc = 'ACCENTS & CONTAINERS'         then 'ACCENTS & CONTAINERS' 
when  sku.grp_desc = 'STORE EVENTS & AS IS'         then 'STORE EVENTS & AS IS'
when  sku.grp_desc = 'CUSTOM FLORAL'                then 'CUSTOM FLORAL'  
when  sku.grp_desc = 'SCRAPBOOKING'                 then 'SCRAPBOOKING' 
when  sku.grp_desc = '15 CUSTOM FRAMING'            then '15 CUSTOM FRAMING' 
when  sku.grp_desc = 'PAPERCRAFTING'                then 'PAPERCRAFTING' 
when  sku.grp_desc = 'NON-MERCHANDISING'            then 'NON-MERCHANDISING' 
when  sku.grp_desc = 'UNFINISHED SURFACES'          then 'UNFINISHED SURFACES'  
when  sku.grp_desc = 'ART SUPPLIES'                 then 'ART SUPPLIES'
when  sku.grp_desc = 'IMPULSE'                      then 'IMPULSE' 
when  sku.grp_desc = 'CUSTOM FRAMING'               then 'CUSTOM FRAMING'
else null end) as product_group
from  customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.day_idnt = tm.day_idnt
inner join ua_ecom_order_dtl ecom on clicks.indiv_id = ecom.indiv_id and (to_date(ecom.dmnd_dt) = tm.day_dt or to_date(ecom.dmnd_dt) = tm.day_dt-1)
left join ua_pos_prod_sku sku on ecom.sku_name = sku.sku_idnt
where tm.wk_idnt between 201807 and 201807 
and ecom.line_item_type = 'DEMAND'
group by clicks.contact_urn, clicks.offer_name, sku.sku.grp_desc;

select * from customer_clicks where rownum <55

select 
count(distinct clicks.indiv_id)                                                                                                                             as clicking_customers,
--count(distinct dtl.indiv_id)                                                                                                                               as store_customers,
--sum(dtl.extended_sls_amt)                                                                                                                                  as store_sales,
--count(distinct dtl.pos_trans_key)                                                                                                                          as store_transactions,
--product.division_group                                                                                                                                     as store_product_type,
--sum(product.division_sales)                                                                                                                                as store_product_sales,
count(distinct clicks.contact_urn_offer_name)                                                                                                                          as clicks,
count(distinct ecom.indiv_id)                                                                                                                              as ecom_customers,
count(distinct ecom.order_id)                                                                                                                              as ecom_trans,
sum(ecom.dmnd_net_ttl_amt)                                                                                                                                as ecom_sales,
sum(ecom.dmnd_unit_cnt)                                                                                                                                   as ecom_units,
clicks.offer_name                                                                                                                                           as offer_name,
product_ecom.product_group                                                                                                                                as ecom_product_type,
sum(product_ecom.group_sales)                                                                                                                           as ecom_product_sales
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.day_idnt= tm.day_idnt
left join ua_pos_trans_dtl dtl on clicks.indiv_id = dtl.indiv_id and dtl.day_idnt between tm.day_idnt and tm.day_idnt+2 and dtl.trans_typ_key in(19,22,33)
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
left join ua_pos_coupon_dtl cpn on dtl.pos_trans_key = cpn.pos_trans_key and dtl.sku_key = cpn.sku_key and dtl.TRANS_DETAIL_SQNC_NBR = cpn.COUPON_SQNC_NBR
left join ua_ecom_order_dtl ecom on ecom.indiv_id = clicks.indiv_id and (to_date(ecom.dmnd_dt) = tm.day_dt or to_date(ecom.dmnd_dt) = tm.day_dt-1) 
--left join  email_product_groups product on clicks.contact_urn||offer.offer_id = product.contact_urn_offer_id
left join  email_product_groups_ecom product_ecom on  clicks.contact_urn_offer_name= product_ecom.contact_urn_offer_name
where tm.wk_idnt between 201807 and 201807
group by clicks.offer_name, product_ecom.product_group;

select 
*
from customer_clicks clicks
inner join ua_pos_tm_day tm on clicks.day_idnt= tm.day_idnt
left join ua_pos_trans_dtl dtl on clicks.indiv_id = dtl.indiv_id and dtl.day_idnt between tm.day_idnt and tm.day_idnt+2 and dtl.trans_typ_key in(19,22,33)
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
left join ua_pos_coupon_dtl cpn on dtl.pos_trans_key = cpn.pos_trans_key and dtl.sku_key = cpn.sku_key and dtl.TRANS_DETAIL_SQNC_NBR = cpn.COUPON_SQNC_NBR
left join ua_ecom_order_dtl ecom on ecom.indiv_id = clicks.indiv_id and (to_date(ecom.dmnd_dt) = tm.day_dt or to_date(ecom.dmnd_dt) = tm.day_dt-1) 
--left join  email_product_groups product on clicks.contact_urn||offer.offer_id = product.contact_urn_offer_id
left join  email_product_groups_ecom product_ecom on  clicks.contact_urn_offer_name= product_ecom.contact_urn_offer_name
where tm.wk_idnt between 201806 and 201806

select 
count(distinct click.contact_urn)       as clicks,
offer.offer_name                        as offer_name,
sum(dtl.extended_sls_amt)               as store_sales, 
count(distinct dtl.pos_Trans_key)       as transactions
from Unica.Ua_Email_Click  click
inner join unica.ua_campaign_offer offer on offer.offer_id = click.offer_id
inner join ua_pos_tm_day tm on to_date(click.trans_dt)= tm.day_dt
inner join ua_email_resolution res on res.contact_urn = click.contact_urn
inner join ua_campaign camp on camp.campaign_id = res.campaign_id
inner join ua_email_ref rf on click.email_id = rf.email_id and rf.pref_indiv_em_flg = 'Y' and rf.valid_email_mktg_flg = 'Y' and rf.ca_valid_email_flg = 'N' and rf.VALID_ADDR_PREF_INDIV_EM_FLG ='Y'
left join ua_pos_trans_dtl dtl on click.indiv_id = dtl.indiv_id and dtl.day_idnt between tm.day_idnt and tm.day_idnt+2 and dtl.trans_typ_key in(19,22,33)
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
where click.wk_idnt = 201807
and offer.offer_name like '50% Off Any One Regular Price Item%%'
group by offer.offer_name
order by clicks desc

