
Create table email_product_groups as
select
click.contact_urn||offer.offer_id as contact_urn_offer_id,  
offer.offer_name,
sku.div_desc, 
sku.grp_desc, 
sku.class_desc, 
sku.sbclass_desc,
(case
when ((UPPER(offer.offer_name)) like '%CUSTOM FRAM%' or (UPPER(offer.offer_name)) like '%CUSTOM-FRAM%'or (UPPER(offer.offer_name)) like '%SCOTT BROTHERS%') and sku.grp_desc like '%CUSTOM FRAMING%' then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%FRAME%' or (UPPER(offer.offer_name)) like'%SHADOW BOXES%' or (UPPER(offer.offer_name)) like'%DISPLAY CASES%') and sku.grp_desc like '%FRAMES%' then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CRICUT%'                                                              and sku.class_desc like '%CRICUT%'             then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CRAYOLA%'                                                             and sku.sbclass_desc like '%CRAYOLA%'          then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%YARN%'                                                                and sku.class_desc like '%YARN%'               then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%PATRICK%'                                                             and sku.sbclass_desc like '%PATRICK%'          then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%VALENTINE%'                                                           and sku.sbclass_desc like '%VALENTINE%'        then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CHRISTMAS%'                                                           and sku.sbclass_desc like '%CHRISTMAS%'        then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%HALLOWEEN%'                                                           and sku.sbclass_desc like '%HALLOWEEN%'        then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%EASTER%'                                                              and sku.sbclass_desc like '%EASTER%'           then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%WEDDING%' or (UPPER(offer.offer_name)) like '%BRIDAL%' or (UPPER(offer.offer_name)) like '%YOUR BIG DAY%') and sku.class_desc like '%WEDDING%'            then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like'%STORAG%' or (UPPER(offer.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(offer.offer_name)) like '%ORGANIZATION%') and sku.class_desc like '%STORAGE%' then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%DECORATIVE BOX%'                                                      and sku.grp_desc like '%DECORATIVE BOX%'       then sum(dtl.extended_sls_amt)
when ((LOWER(offer.offer_name)) like '%dï¿½cor%'or (UPPER(offer.offer_name)) like '%DECOR%')and (UPPER(offer.offer_name)) not like '%DECORAT%'and (UPPER(offer.offer_name)) like '%FLORAL%' and (sku.class_desc like '%DECOR%' or sku.grp_desc like '%FLORAL%')  then sum(dtl.extended_sls_amt)
when ((LOWER(offer.offer_name)) like '%%dï¿½cor%' or (UPPER(offer.offer_name)) like '%DECOR%') and (UPPER(offer.offer_name)) not like '%DECORAT%'and sku.class_desc like '%DECOR%' then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%FLORAL%' or (UPPER(offer.offer_name)) like '%BUSHES%' or (UPPER(offer.offer_name)) like '%WREATHS%' or (UPPER(offer.offer_name)) like '%GARDEN%') and sku.grp_desc like '%FLORAL%' then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CANVAS%'                                                              and sku.class_desc like  '061 CANVAS%'         then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%RIBBON%'                                                              and sku.class_desc like  '%RIBBON%'            then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%BEADS%'                                                               and sku.class_desc like '%BEADS%'              then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%LIGHTING%'                                                            and sku.class_desc like '%LIGHTING%'           then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%MINIATURE%' or (UPPER(offer.offer_name)) like '%MINIS%')              and sku.class_desc like '%MINIATURE%'          then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%SEWING%'                                                              and sku.class_desc like '%SEWING%'             then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%ART SUPPLIES%'                                                        and sku.grp_desc like '%ART SUPPLIES%'         then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%JEWELRY%' or (UPPER(offer.offer_name)) like '%WATCH%' or (UPPER(offer.offer_name)) like '%BRACELET%' or (UPPER(offer.offer_name)) like '%NECKLACE%') and sku.class_desc like '%JEWELRY%'            then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%KIDS%'                                                                and sku.grp_desc like '%KIDS%'                 then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%KNITTING%' or (UPPER(offer.offer_name)) like '%CROCHET%' or (UPPER(offer.offer_name)) like '%NEEDLE%') and sku.grp_desc like '%NEEDLE%' then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%WASHI%'                                                               and sku.sbclass_desc like '%WASHI%'            then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%PLANNER%'                                                             and sku.class_desc like '%PLANNER%'            then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%PAPERCRAFT%'                                                          and sku.grp_desc like '%PAPERCRAFT%'           then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CANDLE%'                                                              and sku.grp_desc like '%CANDLE%'               then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%BAKING%' or (UPPER(offer.offer_name)) like '%WILTON%' or (UPPER(offer.offer_name)) like '%FONDANT%' or (UPPER(offer.offer_name)) like '%CUPCAKES%') and sku.grp_desc like '%FOOD CRAFT%'           then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%T-SHIRTS%'                                                            and sku.class_desc like '%TSHIRT%'             then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%PAPER PADS%' or (UPPER(offer.offer_name)) like'%PAINT%' or (UPPER(offer.offer_name)) like '%PEN %'or (UPPER(offer.offer_name)) like '%PENCIL%' or (UPPER(offer.offer_name)) like '%EASEL%' or (UPPER(offer.offer_name)) like '%FOOTER ART%') and sku.grp_desc like '%ART SUPPLIES%' then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%DRAFTING TABLE%'                                                      and sku.sbclass_desc like '%DRAFTING TABLE%'   then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%SEASONAL%' or (UPPER(offer.offer_name)) like'%SPRING%')              and sku.div_desc like '%SEASONAL%'             then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CRAFT%'                                                               and sku.class_desc like '%GENERAL CRAFT%'      then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%GLUE%'                                                                and sku.sbclass_desc like '%GLUE%'             then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%PHOTO BOXES%'                                                         and sku.sbclass_desc like '%PHOTO BOXES%'      then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%POM POM%'                                                             and sku.sbclass_desc like '%POM POM%'          then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%SCRAPBOOK%'                                                           and sku.sbclass_desc like '%SCRPBOOK%'         then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%JAR%'                                                                 and sku.sbclass_desc like '%JARS%'             then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%METAL STAMPING%'                                                      and sku.sbclass_desc like '%METAL STAMPING%'   then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%CHARGER%'                                                             and sku.class_desc like '%CHARGER%'            then sum(dtl.extended_sls_amt)
when (UPPER(offer.offer_name)) like '%SLIME%'                                                               and sku.class_desc like '%CRAFT ADHESIVE%'     then sum(dtl.extended_sls_amt)
when ((UPPER(offer.offer_name)) like '%OFF ANY ONE REGULAR PRICE%' or (UPPER(offer.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(offer.offer_name)) like '%COUPON%'or (UPPER(offer.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(offer.offer_name)) like '%OFF ENTIRE REGULAR PRICE%') then sum(cpn.extended_sls_amt)
else null end)                                                as division_sales,
(case 
when ((UPPER(offer.offer_name)) like '%CUSTOM FRAM%' or (UPPER(offer.offer_name)) like '%CUSTOM-FRAM%' or (UPPER(offer.offer_name)) like '%SCOTT BROTHERS%') then 'custom framing'
when ((UPPER(offer.offer_name)) like '%FRAME%' or (UPPER(offer.offer_name)) like'%SHADOW BOXES%' or (UPPER(offer.offer_name)) like'%DISPLAY CASES%')       then 'frames'
when (UPPER(offer.offer_name)) like '%CRICUT%'                                                                                                             then 'cricut'
when (UPPER(offer.offer_name)) like '%CRAYOLA%'                                                                                                            then 'crayola'
when (UPPER(offer.offer_name)) like '%YARN%'                                                                                                               then 'yarn'
when (UPPER(offer.offer_name)) like '%PATRICK%'                                                                                                            then 'st.patricks day'
when (UPPER(offer.offer_name)) like '%VALENTINE%'                                                                                                          then 'valentine'
when (UPPER(offer.offer_name)) like '%CHRISTMAS%'                                                                                                          then 'christmas'
when (UPPER(offer.offer_name)) like '%HALLOWEEN%'                                                                                                          then 'halloween'
when (UPPER(offer.offer_name)) like '%EASTER%'                                                                                                             then 'easter'
when ((UPPER(offer.offer_name)) like '%WEDDING%' or (UPPER(offer.offer_name)) like '%BRIDAL%' or (UPPER(offer.offer_name)) like '%YOUR BIG DAY%')          then 'wedding'
when ((UPPER(offer.offer_name)) like '%STORAGE%' or (UPPER(offer.offer_name)) like '%SCRAPBOOK CASES%' or (UPPER(offer.offer_name)) like '%ORGANIZATION%') then 'craft storage'
when (UPPER(offer.offer_name)) like '%DECORATIVE BOX%'                                                                                                     then 'decorative boxes'
when ((LOWER(offer.offer_name)) like '%dï¿½cor%'or (UPPER(offer.offer_name)) like '%DECOR%' )and (UPPER(offer.offer_name)) not like '%DECORAT%' and (UPPER(offer.offer_name)) like '%FLORAL%' then 'floral and decor'
when ((LOWER(offer.offer_name)) like '%%dï¿½cor%'or (UPPER(offer.offer_name)) like '%DECOR%') and (UPPER(offer.offer_name)) not like '%DECORAT%'             then 'decor'
when ((UPPER(offer.offer_name)) like '%FLORAL%' or (UPPER(offer.offer_name)) like '%BUSHES%' or (UPPER(offer.offer_name)) like '%WREATH%' or (UPPER(offer.offer_name)) like '%GARDEN%') then 'floral'
when (UPPER(offer.offer_name)) like '%CANVAS%'                                                                                                             then 'canvas'
when (UPPER(offer.offer_name)) like '%RIBBON%'                                                                                                             then 'ribbon'
when (UPPER(offer.offer_name)) like '%BEADS%'                                                                                                              then 'beads'
when (UPPER(offer.offer_name)) like '%LIGHTING%'                                                                                                           then 'lighting'
when ((UPPER(offer.offer_name)) like '%MINIATURE%' or (UPPER(offer.offer_name)) like '%MINIS%')                                                             then 'miniature'
when (UPPER(offer.offer_name)) like '%SEWING%'                                                                                                             then 'sewing'
when (UPPER(offer.offer_name)) like '%ART SUPPLIES%'                                                                                                       then 'art supplies'
when ((UPPER(offer.offer_name)) like '%JEWELRY%' or (UPPER(offer.offer_name)) like '%WATCH%' or (UPPER(offer.offer_name)) like '%BRACELET%' or (UPPER(offer.offer_name)) like '%NECKLACE%') then 'jewelry'
when (UPPER(offer.offer_name)) like '%KIDS%'                                                                                                               then 'kids'
when ((UPPER(offer.offer_name)) like '%KNITTING%' or (UPPER(offer.offer_name)) like '%CROCHET%' or (UPPER(offer.offer_name)) like '%NEEDLE%')              then 'knitting and needle crafts'
when (UPPER(offer.offer_name)) like '%WASHI%'                                                                                                              then 'washi'
when (UPPER(offer.offer_name)) like '%PLANNER%'                                                                                                            then 'planners'
when (UPPER(offer.offer_name)) like '%PAPERCRAFT%'                                                                                                         then 'papercrafting'
when (UPPER(offer.offer_name)) like '%CANDLE%'                                                                                                             then 'candle'
when ((UPPER(offer.offer_name)) like '%BAKING%' or (UPPER(offer.offer_name)) like '%WILTON%'or (UPPER(offer.offer_name)) like '%FONDANT%' or (UPPER(offer.offer_name)) like '%CUPCAKES%')               then 'baking'
when (UPPER(offer.offer_name)) like '%T-SHIRTS%'                                                                                                           then 'tshirts'
when ((UPPER(offer.offer_name)) like '%PAPER PADS%' or (UPPER(offer.offer_name)) like'%PAINT%' or (UPPER(offer.offer_name)) like '%PEN %'or (UPPER(offer.offer_name)) like '%PENCIL%'  or (UPPER(offer.offer_name)) like '%EASEL%' or (UPPER(offer.offer_name)) like '%FOOTER ART%') then 'art supplies'
when (UPPER(offer.offer_name)) like '%DRAFTING TABLE%'                                                                                                     then 'drafting tables'
when ((UPPER(offer.offer_name)) like '%SEASONAL%' or (UPPER(offer.offer_name)) like'%SPRING%')                                                             then 'seasonal'
when (UPPER(offer.offer_name)) like '%CRAFT%'                                                                                                              then 'general crafts'
when (UPPER(offer.offer_name)) like '%GLUE%'                                                                                                               then 'glue'
when (UPPER(offer.offer_name)) like '%PHOTO BOXES%'                                                                                                        then 'photo boxes'
when (UPPER(offer.offer_name)) like '%POM POM%'                                                                                                            then 'pom poms'
when (UPPER(offer.offer_name)) like '%SCRAPBOOK%'                                                                                                          then 'scrapbook'
when (UPPER(offer.offer_name)) like '%JAR%'                                                                                                                then 'jar'
when (UPPER(offer.offer_name)) like '%METAL STAMPING%'                                                                                                     then 'metal stamping'
when (UPPER(offer.offer_name)) like '%CHARGER%'                                                                                                            then 'charger'
when (UPPER(offer.offer_name)) like '%SLIME%'                                                                                                              then 'slime'
when ((UPPER(offer.offer_name)) like '%OFF ANY ONE REGULAR PRICE%' or (UPPER(offer.offer_name)) like '%OFF ALL REGULAR PRICE%' or (UPPER(offer.offer_name)) like '%COUPON%' or (UPPER(offer.offer_name)) like '%OFF ENTIRE PURCHASE INCLUDING SALE ITEMS%' or (UPPER(offer.offer_name)) like '%OFF ENTIRE REGULAR PRICE%' or (UPPER(offer.offer_name)) like '%AORPI%') then 'coupon sales'
else null end)                                                                                                                                             as division_group
from  unica.ua_email_click click
inner join unica.ua_campaign_offer offer on offer.offer_id = click.offer_id
inner join ua_pos_tm_day tm on to_date(click.trans_dt)= tm.day_dt
left join ua_pos_trans_dtl dtl on click.indiv_id = dtl.indiv_id and dtl.day_idnt between tm.day_idnt and tm.day_idnt+2 and dtl.trans_typ_key in(19,22,33)
inner join ua_email_ref rf on click.email_id = rf.email_id and rf.pref_indiv_em_flg = 'Y' and rf.valid_email_mktg_flg = 'Y' and rf.ca_valid_email_flg = 'N' and rf.VALID_ADDR_PREF_INDIV_EM_FLG ='Y'
left join ua_pos_prod_sku sku on dtl.sku_key = sku.sku_key
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
left join ua_pos_coupon_dtl cpn on dtl.pos_trans_key = cpn.pos_trans_key and dtl.sku_key = cpn.sku_key and dtl.TRANS_DETAIL_SQNC_NBR = cpn.COUPON_SQNC_NBR  
where tm.wk_idnt between 201806 and 201806 
group by  click.contact_urn||offer.offer_id, offer.offer_name, sku.div_desc, sku.grp_desc, sku.class_desc, sku.sbclass_desc;


select 
count(distinct click.indiv_id)                                                                                                                             as clicking_customers,
count(distinct dtl.indiv_id)                                                                                                                               as store_customers,
sum(dtl.extended_sls_amt)                                                                                                                                  as store_sales,
count(distinct dtl.pos_trans_key)                                                                                                                          as store_transactions,
count(distinct click.contact_urn)                                                                                                                          as clicks,
offer.offer_name                                                                                                                                           as offer_name,
product.division_group,
sum(product.division_sales)
from unica.ua_email_click click
inner join unica.ua_campaign_offer offer on offer.offer_id = click.offer_id
inner join ua_pos_tm_day tm on to_date(click.trans_dt)= to_date(tm.day_dt)
inner join ua_email_resolution res on res.contact_urn = click.contact_urn
inner join ua_campaign camp on camp.campaign_id = res.campaign_id
left join ua_pos_trans_dtl dtl on click.indiv_id = dtl.indiv_id and dtl.day_idnt between tm.day_idnt and tm.day_idnt+2 and dtl.trans_typ_key in(19,22,33)
inner join ua_email_ref rf on click.email_id = rf.email_id and rf.pref_indiv_em_flg = 'Y' and rf.valid_email_mktg_flg = 'Y' and rf.ca_valid_email_flg = 'N' and rf.VALID_ADDR_PREF_INDIV_EM_FLG ='Y'
left join ua_pos_prod_sku sku on dtl.sku_key = sku.sku_key
left join ua_store str on dtl.loc_key = str.loc_key and str.distt_idnt != '999'
left join ua_pos_coupon_dtl cpn on dtl.pos_trans_key = cpn.pos_trans_key and dtl.sku_key = cpn.sku_key and dtl.TRANS_DETAIL_SQNC_NBR = cpn.COUPON_SQNC_NBR
left join  email_product_groups product on click.contact_urn||offer.offer_id = contact_urn_offer_id
and offer.channel = 'EMAIL'
group by click.contact_urn, offer.offer_name, product.division_group--, sku.div_desc, sku.grp_desc, sku.class_desc, sku.sbclass_desc)
--group by offer_name
order by clicks desc;
