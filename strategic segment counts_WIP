DEFINE date_lastweek = 081418;
DEFINE date_thisweek = 082018;

%let dorm_mntr_unica_start = '03mar2017';
%let dorm_mntr_unica_end   = '09mar2017';

create table mktss_&date_thisweek. as select distinct email_id from unica.valid_email_marketing_ss;

   create table mktss_compare as 
   select 
            coalesce(lw.email_id, tw.email_id) as email_id,
            rf.ca_valid_email_flg,
            lw.email_id as LW_email,
            tw.email_id as TW_email, 
            E.email_id as LWUAE, 
            f.email_id as TWUAE,
            case when lw.email_id is not null and lw_em.email_id is null and tw_em.email_id is null then 1 else 0 end as invalid,
            case when tw.email_id is null and lw_em.email_id is not null and dorm.email_id is null then 1 else 0 end as unsub ,
            case when tw.email_id is null and lw_em.email_id is not null and dorm.email_id is not null then 1 else 0 end as nowdormant ,
            case when lw.email_id is null and tw.email_id is not null then 1 else 0 end as newe,
            case when lw.email_id is not null and tw.email_id is not null then 1 else 0 end as both,
            case when lw.email_id is not null then 1 else 0 end as LASTWK_total,
            case when tw.email_id is not null then 1 else 0 end as THISWK_total
    from MKTSS_&date_lastweek lw 
    full outer join mktss_&date_thisweek  tw on lw.email_id = tw.email_id
    inner join ua_email_ref rf on rf.email_id = lw.email_id
    inner join ua_email_ref rf on rf.email_id = tw.email_id
    left join ua_email lw_em on lw.email_id = lw_em.email_id
    left join ua_email tw_em on tw.email_id = tw_em.email_id
    left join (select distinct email_id from unica.dormant_unica_ss) dorm on lw.email_id = dorm.email_id
    group by rf.ca_valid_email_flg;
    
    select * from ua_email_ref where rownum <100
    
